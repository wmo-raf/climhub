{% load static wagtailcore_tags %}

<script src="https://code.highcharts.com/maps/highmaps.js"></script>
<script src="https://code.highcharts.com/maps/modules/data.js"></script>
<script src="https://code.highcharts.com/maps/modules/exporting.js"></script>
<script src="https://code.highcharts.com/maps/modules/accessibility.js"></script>
<script src="https://code.highcharts.com/mapdata/custom/africa.topo.json"></script>

<div class="map-section">
    <div class="map-info">
        <h2>{{ value.heading }}</h2>
        {% if self.subheading %}<h3>{{ value.subheading }}</h3>{% endif %}
        <div class="map-description">{{ value.description|richtext }}</div>
    </div>

    <div id="map-container"></div>

</div>

<script>
    function lightenColor(hex, percent) {
        let num = parseInt(hex.replace("#", ""), 16),
            amt = Math.round(2.55 * percent),
            r = (num >> 16) + amt,
            g = (num >> 8 & 0x00FF) + amt,
            b = (num & 0x0000FF) + amt;

        return "#" + (0x1000000 + (r < 255 ? (r < 1 ? 0 : r) : 255) * 0x10000 +
            (g < 255 ? (g < 1 ? 0 : g) : 255) * 0x100 +
            (b < 255 ? (b < 1 ? 0 : b) : 255)).toString(16).slice(1).toUpperCase();
    }

    document.addEventListener("DOMContentLoaded", function () {
        fetch("https://code.highcharts.com/mapdata/custom/africa.topo.json")
            .then(response => response.json())
            .then(topology => {
                Highcharts.mapChart("map-container", {
                    chart: {
                        map: topology
                    },
                    title: { text: "" },
                    legend: { enabled: true },
                    series: [{
                        mapData: topology,
                        joinBy: "hc-key",
                        name: "Countries",
                        states: {
                            hover: {
                                colorKey: "hoverColor"
                            }
                        },
                        dataLabels: {
                            enabled: false,
                            format: "{point.name}",
                            allowOverlap: false,
                            style: { fontSize: '10px', fontWeight: 'bold', color: '#000' },
                            filter: {
                                property: 'name',
                                operator: '!=',
                                value: null
                            }
                        },

                        data: [
                            {% for category in self.map_categories %}
                                {% for country in category.countries %}
                                    {
                                        "hc-key": "{{ country|lower }}",
                                        "color": "{{ category.color }}",
                                        "hoverColor": lightenColor("{{ category.color }}", 20),
                                        "name": "{{ country }}"
                                    },
                                {% endfor %}
                            {% endfor %}
                        ]
                    }]
                });
            });


    });

</script>

